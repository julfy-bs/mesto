(()=>{"use strict";var e,t,n=".form__button",r="popup_active",o=".form",c='[name="link"]',a="Сохранить",u="Сохранение...",s=".feed__item",i=".card__image",l=".card__like-button",d="card__like-button_active",f="card__like-button_liked_true",m=function(e){e.classList.remove(r),function(e){e.removeEventListener("keydown",(function(e){return h(e)})),e.removeEventListener("mousedown",(function(e){return p(e)}))}(e)},v=function(e,t){m(e),e.querySelector(o).removeEventListener("submit",t)},p=function(e){var t=e.target.closest(".popup"),n=e.target.classList.contains("popup")||e.target.classList.contains("popup__close"),r=null!==t.querySelector(o);n&&(r?v(t):m(t))},h=function(e){if("Escape"===e.key){var t=e.target.closest(".popup");null!==t.querySelector(o)?v(t):m(t)}},_=function(e){e.classList.add(r),function(e){e.addEventListener("keydown",(function(e){return h(e)})),e.addEventListener("mousedown",(function(e){return p(e)}))}(e),setTimeout((function(){return e.focus()}),200)},y=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u,r=e.querySelector(n);r.textContent=t},b=function(e,t){_(e),e.querySelector(o).addEventListener("submit",t)},S={baseUrl:"https://nomoreparties.co/v1/plus-cohort-19",headers:{authorization:"0f9e6763-ca59-4d6a-b788-b6c985602524","Content-Type":"application/json"}},E=function(e){return e.ok?e.json():Promise.reject("Ошибка!".concat(e.statusText," Код ошибки: ").concat(e.status,"."))},L=document.querySelector("#card").content.querySelector(s),g=document.querySelector(".feed__list"),q=document.querySelector(".popup_type_delete"),T=q.querySelector(o),x=document.querySelector(".popup_type_photo"),k=x.querySelector(".popup__image"),C=x.querySelector(".popup__figcaption"),A=[],w=null,D=function(e){e.classList.add(d),e.setAttribute("aria-label",'Убрать отметку "Понравилось"')},U=function(e){e.classList.remove(d),e.setAttribute("aria-label",'Добавить отметку "Понравилось"')},N=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;"number"!=typeof n&&console.error("Значение количества лайков карточки должно быть числом"),0===n?(e.classList.remove(f),t.textContent=""):(e.classList.add(f),t.textContent=n)},M=function(t,n){e=0!==t.length&&t.some((function(e){return e._id===n}))},O=function(t,n,r,o,c){var a,u=function(e){return A.find((function(t){return t._id===e}))}(r);switch(M(u.likes,c),e){case!0:(a=r,fetch("".concat(S.baseUrl,"/cards/likes/").concat(a),{method:"DELETE",headers:S.headers}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления лайка карточки. ").concat(e.statusText))}))).then((function(e){M(e.likes,c),u.likes=e.likes})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления лайка карточки: ").concat(e.statusText))}));break;case!1:(function(e){return fetch("".concat(S.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:S.headers}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления лайка карточки. ").concat(e.statusText))}))})(r).then((function(e){M(e.likes,c),u.likes=e.likes})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления лайка карточки: ").concat(e.statusText))}))}var s=Number(n.textContent),i=t.classList.contains(d);i?function(e,t,n){var r=n-1;"number"!=typeof n?console.error("Значение количества лайков карточки должно быть числом"):N(e,t,r)}(t,n,s):function(e,t,n){var r=n+1;"number"!=typeof n?console.error("Значение количества лайков карточки должно быть числом"):N(e,t,r)}(t,n,s),function(e,t){switch(t){case!0:U(e);break;case!1:D(e)}}(t,i)},H=function(e,t){_(x),C.textContent=t.textContent,k.setAttribute("src",e.getAttribute("src")),k.setAttribute("alt",e.getAttribute("alt"))},I=function(e,t){w=function(n){return function(e,t,n){e.preventDefault(),console.warn("TRYING TO DELETE",t,n),y(T);var r=t.closest(s),o=r.querySelector(i),c=r.querySelector(l),u=t;(function(e){return fetch("".concat(S.baseUrl,"/cards/").concat(e),{method:"DELETE",headers:S.headers}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления карточки. ").concat(e.statusText))}))})(n).then((function(){return r.remove()})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления карточки: ").concat(e.statusText))})).finally((function(){var e,t;y(T,a),v(q,(function(e){return w(e)})),T.removeEventListener("submit",(function(e){return w(e)})),w=null,e=u,t=c,o.removeEventListener("mouseup",(function(){return H})),e.removeEventListener("mouseup",(function(){return I})),t.removeEventListener("mouseup",(function(){return O}))}))}(n,e,t)},b(q,(function(e){return w(e)}))},P=function(t,n){var r,o,c=L.cloneNode(!0),a=c.querySelector(".card"),u=a.querySelector(i),s=a.querySelector(".card__title"),d=a.querySelector(".card__like-number"),f=a.querySelector(l),m=a.querySelector(".card__delete"),v=t.likes.length>0?t.likes.length:0;return A.push(t),M(t.likes,n),r=s,o=t.name,r.textContent=o,function(e,t,n){e.setAttribute("src",n),e.setAttribute("alt",t)}(u,t.name,t.link),N(f,d,v),e?D(f):U(f),f.addEventListener("mouseup",(function(){return O(f,d,t._id,t.likes,n)})),u.addEventListener("mouseup",(function(){return H(u,s)})),t.owner._id===n?m.addEventListener("mouseup",(function(){return I(m,t._id)})):m.remove(),c},j=function(e){g.prepend(e)},G=document.querySelector(".popup_type_avatar"),J=document.querySelector(".profile__avatar"),V=document.forms.avatar,B=V.querySelector(c),Y=document.querySelector(".popup_type_edit"),z=document.querySelector(".profile__name"),R=document.querySelector(".profile__image"),W=document.querySelector(".profile__occupation"),F=document.querySelector(".profile__edit"),K=document.forms.profile,Q=K.querySelector('[name="name"]'),X=K.querySelector('[name="occupation"]'),Z=document.querySelector(".popup_type_add"),$=document.querySelector(".profile__add"),ee=document.forms.card,te=(ee.querySelector('[name="title"]'),ee.querySelector(c),function(e){R.setAttribute("src",e)}),ne=function(e){z.textContent=e},re=function(e){W.textContent=e},oe=function e(t){var n,r,o;t.preventDefault(),y(K),ne(Q.value),re(X.value),(n={name:Q.value,about:X.value},r=n.name,o=n.about,fetch("".concat(S.baseUrl,"/users/me"),{method:"PATCH",headers:S.headers,body:JSON.stringify({name:r,about:o})}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," обновления информации пользователя. ").concat(e.statusText))}))).then((function(e){ne(e.name),re(e.about)})).catch((function(e){return console.error("Ошибка ".concat(e.status," редактирования информации профиля: ").concat(e.statusText))})).finally((function(){K.reset(),y(K,a),v(Y,(function(t){return e(t)}))}))},ce=function(){b(Y,(function(e){return oe(e)})),Q.value=z.textContent,X.value=W.textContent},ae=function(e,t,n){e.some((function(e){return!e.validity.valid}))?(t.classList.add(n),t.setAttribute("disabled","disabled")):(t.classList.remove(n),t.removeAttribute("disabled","disabled"))},ue=localStorage.getItem("userId")||null;if($.addEventListener("mousedown",(function(){var e,t,n;(e={name:"test card",link:"https://images.unsplash.com/photo-1564858763975-d99de59ee4bb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1742&q=80"},t=e.name,n=e.link,fetch("".concat(S.baseUrl,"/cards"),{method:"POST",headers:S.headers,body:JSON.stringify({name:t,link:n})}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления карточки. ").concat(e.statusText))}))).then((function(e){var t=P(e,e.owner._id);j(t)})).catch((function(e){console.error("Ошибка ".concat(e.status," cоздания карточки: ").concat(e.statusText))})).finally((function(){ee.reset(),y(ee,"Создать"),m(Z)}))})),F.addEventListener("mousedown",(function(){return ce()})),J.addEventListener("mousedown",(function(){b(G,(function(e){return function(e){var t;e.preventDefault(),y(V),(t=B.value,fetch("".concat(S.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:S.headers,body:JSON.stringify({avatar:t})}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," обновления аватара пользователя. ").concat(e.statusText))}))).then((function(e){te(e.avatar)})).catch((function(e){return console.error("Ошибка ".concat(e.status," изменения аватара пользователя: ").concat(e.statusText))})).finally((function(){V.reset(),y(V,a),m(G)}))}(e)}))})),t={formSelector:".form",inputSelector:".form__input",buttonSelector:n,errorSelector:".form__error",inputErrorClass:"form__input_type_error",buttonDisabledClass:"form__button_type_disabled",errorActiveClass:"form__error_active"},Array.from(document.querySelectorAll(t.formSelector)).forEach((function(e){return n=e,r=t.inputSelector,o=t.buttonSelector,c=t.errorSelector,a=t.inputErrorClass,u=t.buttonDisabledClass,s=t.errorActiveClass,i=Array.from(n.querySelectorAll(r)),l=n.querySelector(o),ae(i,l,u),i.forEach((function(e){e.addEventListener("input",(function(){!function(e,t,n,r,o){var c=t.parentNode.querySelector(n);t.validity.patternMismatch?t.setCustomValidity(t.dataset.invalidMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,n,r,o){n.classList.remove(o),n.textContent="",t.classList.remove(r),t.removeAttribute("aria-describedby")}(0,t,c,r,o):function(e,t,n,r,o,c){n.textContent=r,n.classList.add(c),t.classList.add(o),t.setAttribute("aria-describedby","".concat(c))}(0,t,c,t.validationMessage,r,o)}(0,e,c,a,s),ae(i,l,u)}))})),void n.addEventListener("reset",(function(){setTimeout((function(){return ae(i,l,u)}),0)}));var n,r,o,c,a,u,s,i,l})),document.addEventListener("DOMContentLoaded",(function(){fetch("".concat(S.baseUrl,"/users/me"),{headers:S.headers}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," получения информации о пользователе. ").concat(e.statusText))})).then((function(e){te(e.avatar),ne(e.name),re(e.about),ue=e._id,localStorage.setItem("userId",ue)})),fetch("".concat(S.baseUrl,"/cards"),{headers:S.headers}).then((function(e){return E(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," получения информации о карточках. ").concat(e.statusText))})).then((function(e){e.reverse().forEach((function(e){var t=P(e,ue);j(t)}))}))})),null==EventTarget.prototype.original_addEventListener){function se(e,t,n){console.log("--- add event listener",this.nodeName,e),this.all_handlers=this.all_handlers||[],this.all_handlers.push({typ:e,fn:t,opt:n}),this.original_addEventListener(e,t,n)}EventTarget.prototype.original_addEventListener=EventTarget.prototype.addEventListener,EventTarget.prototype.addEventListener=se}if(null==EventTarget.prototype.original_removeEventListener){function ie(e,t,n){console.log("--- remove event listener",this.nodeName,e),this.all_handlers=this.all_handlers||[],this.all_handlers.push({typ:e,fn:t,opt:n}),this.original_addEventListener(e,t,n)}EventTarget.prototype.original_removeEventListener=EventTarget.prototype.removeEventListener,EventTarget.prototype.removeEventListener=ie}})();