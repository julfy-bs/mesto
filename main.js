(()=>{"use strict";var e,t=".form__button",n="popup_active",r=".form",o='[name="link"]',c="Сохранить",a="Сохранение...",u=".feed__item",s=".card__image",i=".card__like-button",l="card__like-button_active",d="card__like-button_liked_true",f=function(e){!function(e){e.classList.remove(n)}(e),function(e){e.removeEventListener("mousedown",p),e.removeEventListener("keydown",v)}(e)},m=function(e,t){f(e),e.querySelector(r).removeEventListener("submit",t),console.log("popup leave")},p=function(e){var t=e.target.closest(".popup"),n=e.target.classList.contains("popup")||e.target.classList.contains("popup__close"),o=null!==t.querySelector(r);n&&(o?m(t):f(t))},v=function(e){if("Escape"===e.key){var t=e.target.closest(".popup");null!==t.querySelector(r)?m(t):f(t)}},h=function(e){!function(e){e.classList.add(n)}(e),function(e){e.addEventListener("mousedown",p),e.addEventListener("keydown",v)}(e),setTimeout((function(){return e.focus()}),200)},_=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a,r=e.querySelector(t);r.textContent=n},y=function(e,t){console.log("popup enter"),h(e),e.querySelector(r).addEventListener("submit",t)},b={baseUrl:"https://nomoreparties.co/v1/plus-cohort-19",headers:{authorization:"0f9e6763-ca59-4d6a-b788-b6c985602524","Content-Type":"application/json"}},S=function(e){return e.ok?e.json():Promise.reject("Ошибка!".concat(e.statusText," Код ошибки: ").concat(e.status,"."))},E=document.querySelector("#card").content.querySelector(u),L=document.querySelector(".feed__list"),g=document.querySelector(".popup_type_delete"),q=g.querySelector(r),T=document.querySelector(".popup_type_photo"),x=T.querySelector(".popup__image"),k=T.querySelector(".popup__figcaption"),C=[],A=null,w=function(e){e.classList.add(l),e.setAttribute("aria-label",'Убрать отметку "Понравилось"')},D=function(e){e.classList.remove(l),e.setAttribute("aria-label",'Добавить отметку "Понравилось"')},U=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;"number"!=typeof n&&console.error("Значение количества лайков карточки должно быть числом"),0===n?(e.classList.remove(d),t.textContent=""):(e.classList.add(d),t.textContent=n)},N=function(t,n){e=0!==t.length&&t.some((function(e){return e._id===n}))};function M(t,n,r,o,c){var a,u=function(e){return C.find((function(t){return t._id===e}))}(r);switch(N(u.likes,c),e){case!0:(a=r,fetch("".concat(b.baseUrl,"/cards/likes/").concat(a),{method:"DELETE",headers:b.headers}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления лайка карточки. ").concat(e.statusText))}))).then((function(e){N(e.likes,c),u.likes=e.likes})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления лайка карточки: ").concat(e.statusText))}));break;case!1:(function(e){return fetch("".concat(b.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:b.headers}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления лайка карточки. ").concat(e.statusText))}))})(r).then((function(e){N(e.likes,c),u.likes=e.likes})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления лайка карточки: ").concat(e.statusText))}))}var s=Number(n.textContent),i=t.classList.contains(l);i?function(e,t,n){var r=n-1;"number"!=typeof n?console.error("Значение количества лайков карточки должно быть числом"):U(e,t,r)}(t,n,s):function(e,t,n){var r=n+1;"number"!=typeof n?console.error("Значение количества лайков карточки должно быть числом"):U(e,t,r)}(t,n,s),function(e,t){switch(t){case!0:D(e);break;case!1:w(e)}}(t,i)}function O(e,t){h(T),k.textContent=t.textContent,x.setAttribute("src",e.getAttribute("src")),x.setAttribute("alt",e.getAttribute("alt"))}function H(e,t){A=function(n){return function(e,t,n){e.preventDefault(),console.warn("TRYING TO DELETE",t,n),_(q);var r=t.closest(u),o=r.querySelector(s),a=r.querySelector(i),l=t;(function(e){return fetch("".concat(b.baseUrl,"/cards/").concat(e),{method:"DELETE",headers:b.headers}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления карточки. ").concat(e.statusText))}))})(n).then((function(){return r.remove()})).catch((function(e){return console.error("Ошибка ".concat(e.status," удаления карточки: ").concat(e.statusText))})).finally((function(){var e,t;_(q,c),m(g,A),A=null,e=l,t=a,o.removeEventListener("mouseup",(function(){return O})),e.removeEventListener("mouseup",(function(){return H})),t.removeEventListener("mouseup",(function(){return M}))}))}(n,e,t)},y(g,(function(e){return A(e)}))}var I,P=function(t,n){var r,o,c=E.cloneNode(!0),a=c.querySelector(".card"),u=a.querySelector(s),l=a.querySelector(".card__title"),d=a.querySelector(".card__like-number"),f=a.querySelector(i),m=a.querySelector(".card__delete"),p=t.likes.length>0?t.likes.length:0;return C.push(t),N(t.likes,n),r=l,o=t.name,r.textContent=o,function(e,t,n){e.setAttribute("src",n),e.setAttribute("alt",t)}(u,t.name,t.link),U(f,d,p),e?w(f):D(f),f.addEventListener("mouseup",(function(){return M(f,d,t._id,t.likes,n)})),u.addEventListener("mouseup",(function(){return O(u,l)})),t.owner._id===n?m.addEventListener("mouseup",(function(){return H(m,t._id)})):m.remove(),c},j=function(e){L.prepend(e)},G=document.querySelector(".popup_type_avatar"),J=document.querySelector(".profile__avatar"),V=document.forms.avatar,B=V.querySelector(o),Y=document.querySelector(".popup_type_edit"),z=document.querySelector(".profile__name"),R=document.querySelector(".profile__image"),W=document.querySelector(".profile__occupation"),F=document.querySelector(".profile__edit"),K=document.forms.profile,Q=K.querySelector('[name="name"]'),X=K.querySelector('[name="occupation"]'),Z=document.querySelector(".popup_type_add"),$=document.querySelector(".profile__add"),ee=document.forms.card,te=(ee.querySelector('[name="title"]'),ee.querySelector(o),function(e){R.setAttribute("src",e)}),ne=function(e){z.textContent=e},re=function(e){W.textContent=e},oe=function e(t){var n,r,o;t.preventDefault(),_(K),ne(Q.value),re(X.value),(n={name:Q.value,about:X.value},r=n.name,o=n.about,fetch("".concat(b.baseUrl,"/users/me"),{method:"PATCH",headers:b.headers,body:JSON.stringify({name:r,about:o})}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," обновления информации пользователя. ").concat(e.statusText))}))).then((function(e){ne(e.name),re(e.about)})).catch((function(e){return console.error("Ошибка ".concat(e.status," редактирования информации профиля: ").concat(e.statusText))})).finally((function(){K.reset(),_(K,c),m(Y,(function(t){return e(t)}))}))},ce=function(){y(Y,(function(e){return oe(e)})),Q.value=z.textContent,X.value=W.textContent},ae=function(e,t,n){e.some((function(e){return!e.validity.valid}))?(t.classList.add(n),t.setAttribute("disabled","disabled")):(t.classList.remove(n),t.removeAttribute("disabled","disabled"))},ue=localStorage.getItem("userId")||null;if($.addEventListener("mousedown",(function(){var e,t,n;(e={name:"test card",link:"https://images.unsplash.com/photo-1564858763975-d99de59ee4bb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1742&q=80"},t=e.name,n=e.link,fetch("".concat(b.baseUrl,"/cards"),{method:"POST",headers:b.headers,body:JSON.stringify({name:t,link:n})}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," добавления карточки. ").concat(e.statusText))}))).then((function(e){var t=P(e,e.owner._id);j(t)})).catch((function(e){console.error("Ошибка ".concat(e.status," cоздания карточки: ").concat(e.statusText))})).finally((function(){ee.reset(),_(ee,"Создать"),f(Z)}))})),F.addEventListener("mousedown",(function(){return ce()})),J.addEventListener("mousedown",(function(){y(G,(function(e){return function(e){var t;e.preventDefault(),_(V),(t=B.value,fetch("".concat(b.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:b.headers,body:JSON.stringify({avatar:t})}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," обновления аватара пользователя. ").concat(e.statusText))}))).then((function(e){te(e.avatar)})).catch((function(e){return console.error("Ошибка ".concat(e.status," изменения аватара пользователя: ").concat(e.statusText))})).finally((function(){V.reset(),_(V,c),f(G)}))}(e)}))})),I={formSelector:".form",inputSelector:".form__input",buttonSelector:t,errorSelector:".form__error",inputErrorClass:"form__input_type_error",buttonDisabledClass:"form__button_type_disabled",errorActiveClass:"form__error_active"},Array.from(document.querySelectorAll(I.formSelector)).forEach((function(e){return t=e,n=I.inputSelector,r=I.buttonSelector,o=I.errorSelector,c=I.inputErrorClass,a=I.buttonDisabledClass,u=I.errorActiveClass,s=Array.from(t.querySelectorAll(n)),i=t.querySelector(r),ae(s,i,a),s.forEach((function(e){e.addEventListener("input",(function(){!function(e,t,n,r,o){var c=t.parentNode.querySelector(n);t.validity.patternMismatch?t.setCustomValidity(t.dataset.invalidMessage):t.setCustomValidity(""),t.validity.valid?function(e,t,n,r,o){n.classList.remove(o),n.textContent="",t.classList.remove(r),t.removeAttribute("aria-describedby")}(0,t,c,r,o):function(e,t,n,r,o,c){n.textContent=r,n.classList.add(c),t.classList.add(o),t.setAttribute("aria-describedby","".concat(c))}(0,t,c,t.validationMessage,r,o)}(0,e,o,c,u),ae(s,i,a)}))})),void t.addEventListener("reset",(function(){setTimeout((function(){return ae(s,i,a)}),0)}));var t,n,r,o,c,a,u,s,i})),document.addEventListener("DOMContentLoaded",(function(){fetch("".concat(b.baseUrl,"/users/me"),{headers:b.headers}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," получения информации о пользователе. ").concat(e.statusText))})).then((function(e){te(e.avatar),ne(e.name),re(e.about),ue=e._id,localStorage.setItem("userId",ue)})),fetch("".concat(b.baseUrl,"/cards"),{headers:b.headers}).then((function(e){return S(e)})).catch((function(e){return console.error("Ошибка ".concat(e.status," получения информации о карточках. ").concat(e.statusText))})).then((function(e){e.reverse().forEach((function(e){var t=P(e,ue);j(t)}))}))})),null==EventTarget.prototype.original_addEventListener){function se(e,t,n){console.log("--- add event listener",this.nodeName,e),this.all_handlers=this.all_handlers||[],this.all_handlers.push({typ:e,fn:t,opt:n}),this.original_addEventListener(e,t,n)}EventTarget.prototype.original_addEventListener=EventTarget.prototype.addEventListener,EventTarget.prototype.addEventListener=se}if(null==EventTarget.prototype.original_removeEventListener){function ie(e,t,n){console.log("--- remove event listener",this.nodeName,e),this.all_handlers=this.all_handlers||[],this.all_handlers.push({typ:e,fn:t,opt:n}),this.original_addEventListener(e,t,n)}EventTarget.prototype.original_removeEventListener=EventTarget.prototype.removeEventListener,EventTarget.prototype.removeEventListener=ie}})();